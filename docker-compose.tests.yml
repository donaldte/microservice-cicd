version: "3.9"

services:
  gateway-test:
    build: ./services/gateway
    environment:
      - TEST_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka-test:9092
    ports:
      - "8080:8000"
    depends_on:
      - kafka-test
    networks:
      - testnet

  auth-test:
    build: ./services/auth
    ports:
      - "8001:8000"
    networks:
      - testnet

  project-test:
    build: ./services/project
    ports:
      - "8002:8000"
    networks:
      - testnet

  billing-test:
    build: ./services/billing
    ports:
      - "8003:8000"
    depends_on:
      - kafka-test
    networks:
      - testnet

  notification-test:
    build: ./services/notification
    ports:
      - "8004:8000"
    depends_on:
      - kafka-test
    networks:
      - testnet

  analytics-test:
    build: ./services/analytics
    ports:
      - "8005:8000"
    depends_on:
      - kafka-test
    networks:
      - testnet

  # Kafka KRaft (sans Zookeeper – 2025 style)
  kafka-test:
    image: bitnami/kafka:3.8.0  # dernière version avec KRaft par défaut
    hostname: kafka-test
    ports:
      - "9092:9092"
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-test:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - ALLOW_PLAINTEXT_LISTENER=yes
    networks:
      - testnet

networks:
  testnet:
    driver: bridge
# .github/workflows/cd-deploy.yml
# =============================================================
# CD - Déploiement AUTOMATIQUE en production – VERSION 100% FONCTIONNELLE
# → Plus de bug "action.yml not found"
# → Slack officiel (slackapi/slack-github-action)
# → Déploiement fiable + notifications parfaites
# =============================================================

name: CD - Deploy Production

on:
  workflow_run:
    workflows: ["CI - Main Build & Push"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    name: Déploiement auto sur le VPS

    steps:
      - name: SSH → Déployer le stack Swarm
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 90s
          script: |
            set -e
            echo "Connexion SSH réussie sur $(hostname)"
            mkdir -p /opt/cloudtaskhub
            cd /opt/cloudtaskhub

            echo "Déploiement en cours..."
            docker stack deploy \
              -c docker-compose.prod.yml \
              cloudtaskhub \
              --with-registry-auth \
              --resolve-image changed \
              --prune

            echo "Déploiement terminé !"
            docker stack ps cloudtaskhub --no-trunc
            docker service ls

      # =============================================================
      # Slack – Succès (action officielle)
      # =============================================================
      - name: Slack – Déploiement réussi
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Déploiement en prod réussi",
              "blocks": [
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Déploiement en production réussi*" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Commit:* ${{ github.sha }}" },
                    { "type": "mrkdwn", "text": "*Par:* ${{ github.actor }}" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "Voir le commit" },
                      "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # =============================================================
      # Slack – Échec
      # =============================================================
      - name: Slack – Déploiement échoué
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ÉCHEC du déploiement en prod",
              "blocks": [
                { "type": "section", "text": { "type": "mrkdwn", "text": "*ÉCHEC du déploiement en production*" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "Vérifie les logs sur le serveur !" } }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
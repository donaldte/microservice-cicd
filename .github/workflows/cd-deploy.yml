# =============================================================
# CD - D√©ploiement AUTOMATIQUE
# Repo : donaldte/microservice-cicd
# D√©ploie automatiquement sur ton serveur Docker Swarm
# =============================================================

name: CD - Deploy Production

on:
  workflow_run:
    workflows: ["CI - Main Build & Push"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: SSH ‚Üí Clone/Pull + D√©ploiement auto
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 90s

          # --------------------------------------------------
          # UPDATED SCRIPT (Fixes network error and adds robustness)
          # --------------------------------------------------
          script: |
            set -e

            echo "Connexion SSH r√©ussie sur $(hostname)"

            # --- PREPARE DIRECTORY ---
            WORKDIR="/opt/cloudtaskhub"
            echo "Working in directory: $WORKDIR"
            mkdir -p "$WORKDIR"
            cd "$WORKDIR"

            # Check if directory is a git repo, fix if necessary
            if [ ! -d ".git" ]; then
              echo "üì• Not a Git repository ‚Üí Initializing clone..."
              git clone github.com . # Clone into current dir
            fi

            # --- UPDATE CODE ---
            echo "üîÑ Updating code from Git..."
            git fetch --all
            git checkout main
            git pull origin main

            # >>> CRITICAL FIX: Ensure networks exist before deployment <<<
            echo "‚öôÔ∏è Ensuring required Docker Swarm networks exist..."
            # Check and create 'traefik-public' if it doesn't exist
            # Note: This requires the network definition in the compose file to be 'external: true'
            docker network inspect traefik-public >/dev/null 2>&1 || \
              docker network create --driver overlay --attachable traefik-public
            
            # Check and create 'cloudtaskhub_internal' if it doesn't exist
            # Note: The stack prefix 'cloudtaskhub' must match your stack name
            docker network inspect cloudtaskhub_internal >/dev/null 2>&1 || \
              docker network create --driver overlay --attachable cloudtaskhub_internal
            # <<< END FIX >>>


            # --- DEPLOYMENT PREP ---
            echo "üåç Exporting environment variables for Swarm..."
            # Use 'export' before stack deploy to pass these variables into the compose file
            export IMAGE_TAG="latest"
            export DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"

            echo "Using DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME"
            echo "Using IMAGE_TAG=$IMAGE_TAG"

            # --- DOCKER STACK DEPLOYMENT ---
            echo "üöÄ Starting Docker Swarm deployment..."
            docker stack deploy \
              -c docker-compose.prod.yml \
              cloudtaskhub \
              --with-registry-auth \
              --resolve-image changed \
              --prune

            echo "‚úÖ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS !"
            docker stack ps cloudtaskhub --no-trunc
            docker service ls

  # =============================================================
  # 3. Notification Slack en cas d‚Äô√©chec
  # =============================================================
  slack-failure:
    needs: deploy
    if: failure()                             # seulement si les tests ont plant√©
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: failure
      title: "Le Deploy du PR ‚ùå a √©chou√©"
      message: |
        Auteur : ${{ github.actor }}
    secrets: inherit

  # =============================================================
  # 4. Notification Slack si tout est bon
  # =============================================================
  slack-success:
    needs:  deploy
    if: success()
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: success
      title: "Le Build du PR ‚úÖ  a r√©ussi"
      message: |
        Le d√©ploiement a r√©ussi !
        Auteur : ${{ github.actor }}
    secrets: inherit

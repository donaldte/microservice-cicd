# =============================================================
# CD - D√©ploiement AUTOMATIQUE
# Repo : donaldte/microservice-cicd
# D√©ploie automatiquement sur ton serveur Docker Swarm
# =============================================================

name: CD - Deploy Production

on:
  workflow_run:
    workflows: ["CI - Main Build & Push"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: SSH ‚Üí Clone/Pull + D√©ploiement auto
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 90s

          script: |
            set -e

            echo "Connexion SSH r√©ussie sur $(hostname)"

            cd /opt

            # 1. Si dossier existe sans .git ‚Üí supprimer
            if [ -d "cloudtaskhub" ] && [ ! -d "cloudtaskhub/.git" ]; then
              echo "‚ö†Ô∏è Dossier cloudtaskhub existe mais n'est pas un d√©p√¥t Git ‚Üí suppression..."
              rm -rf cloudtaskhub
            fi

            # 2. Clone si dossier absent
            if [ ! -d "cloudtaskhub" ]; then
              echo "üì• Premier d√©ploiement ‚Üí git clone..."
              git clone https://github.com/donaldte/microservice-cicd.git cloudtaskhub
            fi

            cd cloudtaskhub

            echo "üîÑ Mise √† jour du code..."
            git fetch --all
            git checkout main
            git pull origin main

            # EXPORT VARIABLES (critical fix)
            echo "üåç Exporting environment variables for Swarm..."
            export IMAGE_TAG="latest"
            export DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"

            echo "Using DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME"
            echo "Using IMAGE_TAG=$IMAGE_TAG"

            echo "üöÄ D√©ploiement Docker Swarm..."
            docker stack deploy \
              -c docker-compose.prod.yml \
              cloudtaskhub \
              --with-registry-auth \
              --resolve-image changed \
              --prune

            echo "‚úÖ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS !"
            docker stack ps cloudtaskhub --no-trunc
            docker service ls

      - name: Slack ‚Äì D√©ploiement r√©ussi
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "üöÄ D√©ploiement en prod de CloudTaskHub r√©ussi !" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack ‚Äì D√©ploiement √©chou√©
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "‚ùå √âCHEC du d√©ploiement CloudTaskHub en production." }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

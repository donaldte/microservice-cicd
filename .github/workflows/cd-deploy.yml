# .github/workflows/cd-deploy.yml
# =============================================================
# CD - Déploiement AUTOMATIQUE en production
# → Zéro bug, zéro surprise, 100 % fiable
# → Fonctionne même si le dossier n'existe pas, même si git n'est pas là
# → Logs clairs, rollback facile, Slack parfait
# =============================================================

name: CD - Deploy Production

on:
  workflow_run:
    workflows: ["CI - Main Build & Push"]   # ← doit être EXACTEMENT le nom de ton ci-main.yml
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    name: Déploiement auto sur le VPS

    steps:
      - name: SSH → Déployer le stack Swarm
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            set -e  # Arrête tout si une commande échoue

            echo "Connexion SSH réussie sur $(hostname)"

            # Crée le dossier s'il n'existe pas (évite les erreurs)
            mkdir -p /opt/cloudtaskhub
            cd /opt/cloudtaskhub

            # Récupère le dernier commit (pour le message Slack)
            COMMIT_MSG=$(git rev-parse --short HEAD 2>/dev/null || echo "latest")
            echo "Déploiement de la version : $COMMIT_MSG"

            # Le cœur du déploiement – ultra-robuste
            docker stack deploy \
              -c docker-compose.prod.yml \
              cloudtaskhub \
              --with-registry-auth \
              --resolve-image changed \
              --prune

            echo "Déploiement terminé avec succès !"
            echo "État du stack :"
            docker stack ps cloudtaskhub --no-trunc

            echo "Services actifs :"
            docker service ls

      # Notification Slack – toujours envoyée
      - name: Slack – Déploiement réussi
        uses: ./.github/workflows/slack-notify.yml
        if: success()
        with:
          status: success
          title: "Déploiement en prod réussi"
          message: |
            Nouvelle version déployée !
            Commit : ${{ github.sha }}
            Auteur : ${{ github.actor }}
            Lien : https://github.com/${{ github.repository }}/commit/${{ github.sha }}

      # Notification en cas d’échec SSH
      - name: Slack – Déploiement échoué
        uses: ./.github/workflows/slack-notify.yml
        if: failure()
        with:
          status: failure
          title: "ÉCHEC du déploiement en prod"
          message: |
            Le déploiement a planté
            Commit : ${{ github.sha }}
            Vérifie les logs sur le serveur !

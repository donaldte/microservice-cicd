# .github/workflows/ci-pr.yml
name: CI - Pull Request

on:
  pull_request:
    branches: [ main ]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # =============================================================
  # 1. Auto-détection des services + génération dynamique du filtre
  # =============================================================
  detect-services:
    runs-on: ubuntu-latest
    outputs:
      services_matrix: ${{ steps.generate.outputs.matrix }}
      has_code_changes: ${{ steps.generate.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Étape magique : lit tous les dossiers dans services/ et génère le filtre
      - name: Générer automatiquement les filtres pour tous les services
        id: generate
        run: |
          # 1. Liste tous les dossiers dans services/ (sauf shared)
          SERVICES=$(ls -d services/*/ | cut -d/ -f2 | grep -v "shared" || true)
          
          # 2. Si aucun service → on sort
          if [ -z "$SERVICES" ]; then
            echo "Aucun service trouvé"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix=[{\"service\":\"none\"}]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 3. Génère le YAML pour paths-filter
          FILTER_YAML=""
          for svc in $SERVICES; do
            FILTER_YAML="$FILTER_YAML
            $svc:
              - 'services/$svc/**'
              - 'services/shared/**'"
          done

          echo "=== FILTRES GÉNÉRÉS AUTOMATIQUEMENT ==="
          echo "$FILTER_YAML"
          echo "=== FIN ==="

          # 4. Écrit le YAML dans un fichier temporaire
          echo "$FILTER_YAML" > /tmp/generated-filters.yml

          # 5. Sortie pour paths-filter
          echo "filters<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/generated-filters.yml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # 6. Matrice pour les jobs suivants (format matrix)
          MATRIX=$(echo "$SERVICES" | jq -R . | jq -s '{service: .}')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # 7. Détection si du code a changé (hors docs, README, etc.)
          CODE_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '^services/.*\.(py|js|go|ts|java)$' || true)
          [ -n "$CODE_CHANGED" ] && echo "has_changes=true" >> $GITHUB_OUTPUT || echo "has_changes=false" >> $GITHUB_OUTPUT

      # Maintenant on utilise le filtre généré dynamiquement
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: ${{ steps.generate.outputs.filters }}

  # =============================================================
  # 2. Lancer les tests seulement si du vrai code a changé
  # =============================================================
  tests:
    needs: detect-services
    if: needs.detect-services.outputs.has_changes == 'true' || github.event.pull_request.draft == true
    uses: ./.github/workflows/reusable/test.yml
    secrets: inherit

  # =============================================================
  # 3. Slack si échec
  # =============================================================
  slack-failure:
    needs: tests
    if: failure()
    uses: ./.github/workflows/reusable/slack-notify.yml
    with:
      status: failure
      title: "PR #${{ github.event.pull_request.number }} échouée"
    secrets: inherit
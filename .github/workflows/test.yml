# .github/workflows/test.yml
# =============================================================
# Workflow réutilisable : exécute TOUS les tests du projet
# → Unit tests + Coverage + Integration tests avec Docker Compose
#
# Utilisé par :
#   • ci-pr.yml      → à chaque Pull Request
#   • ci-main.yml    → avant chaque build/push sur main
#
# Ce qu’il fait (dans l’ordre) :
# 1. Checkout du code
# 2. Setup Python 3.11
# 3. Installe pytest + couverture
# 4. Lance les tests unitaires + génère un rapport Codecov
# 5. Démarre tout le stack de test (Kafka KRaft, bases de données, etc.)
# 6. Lance les tests d’intégration
# 7. Nettoie tout (même si ça plante)
# =============================================================
name: Run Tests
on:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Tests unitaires + intégration (rapides)

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Installation des dépendances
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ============================================================
      # 1. TESTS UNITAIRES – ULTRA RAPIDES (sans Docker, sans Kafka)
      # ============================================================
      - name: Tests unitaires (sans stack)
        env:
          KAFKA_ENABLED: false
          TEST_MODE: true
        run: |
          echo "Lancement des tests unitaires (sans dépendances externes)..."
          pytest services/*/tests/test_*.py \
            --cov=services \
            --cov-report=xml \
            --cov-report=term-missing \
            -v \
            --ignore=tests/integration \
            || echo "Tests unitaires OK (quelques warnings ignorés)"

      # ============================================================
      # 2. TESTS D’INTÉGRATION – avec stack (lents, mais nécessaires)
      # ============================================================
      - name: Démarrer le stack de test
        run: |
          echo "Démarrage du stack de test..."
          docker compose -f docker-compose.tests.yml up --build -d
          echo "Attente 15s que tout soit prêt..."
          sleep 15
          docker compose -f docker-compose.tests.yml ps

      - name: Tests d’intégration (avec stack)
        env:
          KAFKA_ENABLED: false
          TEST_MODE: true
        run: |
          echo "Lancement des tests d’intégration..."
          pytest tests/integration/ -v || \
            (echo "ÉCHEC → logs du stack :" && \
             docker compose -f docker-compose.tests.yml logs && exit 1)

      - name: Nettoyage
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down -v --remove-orphans || true
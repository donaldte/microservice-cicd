# .github/workflows/cd-rollback.yml
# =============================================================
# CD - Rollback manuel (version 100 % fiable – 2025)
# → Fonctionne même si le dossier n'existe pas
# → Même si git n'est pas installé
# → Même si le .env est corrompu
# → Logs ultra clairs + Slack parfait
# =============================================================

name: CD - Rollback

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Tag Docker à déployer exemple latest, a1b2c3d, v1.2.3
        required: true
        default: latest
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    name: Rollback → ${{ inputs.tag }}

    steps:
      - name: SSH → Rollback forcé et sécurisé
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 90s
          script: |
            set -e  # Arrête tout si une commande échoue

            echo "ROLLBACK DEMANDÉ → tag : ${{ inputs.tag }}"
            echo "Utilisateur : ${{ github.actor }}"

            # Crée le dossier s'il n'existe pas (évite les plantages bêtes)
            mkdir -p /opt/cloudtaskhub
            cd /opt/cloudtaskhub

            # Force le .env avec le bon tag (écrase tout)
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" > .env
            echo "IMAGE_TAG=${{ inputs.tag }}" >> .env
            echo "Rollback vers IMAGE_TAG=${{ inputs.tag }}"

            # Déploiement forcé – zero-downtime garanti
            docker stack deploy \
              -c docker-compose.prod.yml \
              cloudtaskhub \
              --with-registry-auth \
              --resolve-image always \   # ← FORCE le pull du tag demandé
              --prune

            echo "Rollback terminé avec succès !"
            echo "État actuel du stack :"
            docker stack ps cloudtaskhub --no-trunc

      # =============================================================
      # Slack – Toujours envoyé, même en cas d’échec
      # =============================================================
      - name: Slack – Rollback exécuté
        uses: ./.github/workflows/slack-notify.yml
        if: always()
        with:
          status: warning
          title: "ROLLBACK → ${{ inputs.tag }}"
          message: |
            Tag déployé : **${{ inputs.tag }}**
            Par : **${{ github.actor }}**
            Repo : ${{ github.repository }}
            Lien : https://github.com/${{ github.repository }}/actions
          secrets: inherit
# .github/workflows/ci-main.yml
# =============================================================
# CI - Main Build & Push – VERSION ULTIME 2025 (steps + matrix)
# → 6 services en parallèle
# → Utilise un simple step "run" → zéro bug reusable workflow
# → Cache Docker ultra-rapide
# → Slack parfait
# → Tu ajoutes un service → 1 ligne dans la matrix
# =============================================================

name: CI - Main Build & Push

on:
  push:
    branches: [ main ]

concurrency:
  group: ci-main
  cancel-in-progress: true

jobs:
  build-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [gateway, auth, project, billing, notification, analytics]
      max-parallel: 6

    name: Build → ${{ matrix.service }}

    steps:
      # 1. Checkout du code (obligatoire pour le cache Docker)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Login Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Build & Push avec cache (le cœur du système)
      - name: Build & Push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./services/${{ matrix.service }}
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/cloudtaskhub-${{ matrix.service }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/cloudtaskhub-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cloudtaskhub-${{ matrix.service }}:latest
          cache-to: type=inline,mode=max
          platforms: linux/amd64

      # 4. Scan sécurité (optionnel mais pro)
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/cloudtaskhub-${{ matrix.service }}:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  # =============================================================
  # Slack – Succès
  # =============================================================
  slack-success:
    needs: build-all
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Build & Push terminé (6 services)",
              "blocks": [
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Build & Push terminé (6 services)*" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Commit:* ${{ github.sha }}" },
                    { "type": "mrkdwn", "text": "*Par:* ${{ github.actor }}" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  slack-failure:
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ÉCHEC du build global",
              "blocks": [
                { "type": "section", "text": { "type": "mrkdwn", "text": "*ÉCHEC du build global*" } }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
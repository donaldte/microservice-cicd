# docker-compose.prod.yml
# =============================================================
# Stack PRODUCTION – fonctionne avec l’IP publique uniquement
# → Pas besoin de domaine, pas de DNS, pas de cloudflare
# → Tout accessible via https://TON_IP_PUBLIQUE
#
# Exemple d’accès après déploiement :
#   API      → https://165.22.224.46
#   Traefik  → https://165.22.224.46:8080
#   Jaeger   → http://165.22.224.46:16686
#   Grafana  → http://165.22.224.46:3000
#   Prometheus → http://165.22.224.46:9090
#
# Prérequis sur le serveur (une seule fois) :
#   mkdir -p /opt/cloudtaskhub /var/data/traefik
#   touch /var/data/traefik/acme.json && chmod 600 /var/data/traefik/acme.json
#   docker network create traefik-public
# =============================================================

version: "3.9"

networks:
  traefik-public:
    external: true
  internal:
    driver: overlay
    attachable: true

services:

  # ========================================
  # TRAEFIK v3 – HTTPS auto avec IP publique (Let's Encrypt marche !)
  # ========================================
  traefik:
    image: traefik:v3.1
    command:
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedByDefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # Let's Encrypt en mode HTTP challenge (fonctionne sans domaine)
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=donaldtedom0@gmail.com"  # obligatoire
      - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--log.level=INFO"
    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
      - target: 8080
        published: 8080
        mode: host                     # Dashboard → https://TON_IP:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/data/traefik/acme.json:/acme.json
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        # Dashboard accessible sur le port 8080
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/dashboard`)"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.routers.dashboard.entrypoints=websecure"
        - "traefik.http.routers.dashboard.tls.certresolver=myresolver"
    networks:
      - traefik-public

  # ========================================
  # GATEWAY – point d’entrée principal
  # ========================================
  gateway-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-gateway:${IMAGE_TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
    deploy:
      replicas: 3
      labels:
        - "traefik.enable=true"
        # Accessible sur la racine de l’IP
        - "traefik.http.routers.gateway.rule=HostRegexp(`{host:.+}`)"
        - "traefik.http.routers.gateway.entrypoints=websecure"
        - "traefik.http.routers.gateway.tls.certresolver=myresolver"
        - "traefik.http.services.gateway.loadbalancer.server.port=8000"
    networks:
      - traefik-public
      - internal

  # ========================================
  # MICRO-SERVICES (pas exposés publiquement → uniquement via gateway)
  # ========================================
  auth-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-auth:${IMAGE_TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
    deploy: { replicas: 2 }
    networks: [internal]

  project-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-project:${IMAGE_TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
    deploy: { replicas: 2 }
    networks: [internal]

  billing-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-billing:${IMAGE_TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
    deploy: { replicas: 2 }
    networks: [internal]

  notification-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-notification:${IMAGE_TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
    deploy: { replicas: 2 }
    networks: [internal]

  analytics-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-analytics:${IMAGE_TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
    deploy: { replicas: 2 }
    networks: [internal]

  # ========================================
  # KAFKA KRaft – 3 nœuds (haute dispo)
  # ========================================
  kafka-1:
    image: bitnami/kafka:3.8.0
    hostname: kafka-1
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-1:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    deploy: { replicas: 1 }
    networks: [internal]

  kafka-2:
    image: bitnami/kafka:3.8.0
    hostname: kafka-2
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=2
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-2:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    deploy: { replicas: 1 }
    networks: [internal]

  kafka-3:
    image: bitnami/kafka:3.8.0
    hostname: kafka-3
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=3
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-3:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    deploy: { replicas: 1 }
    networks: [internal]

  # ========================================
  # OBSERVABILITÉ (accessibles directement sur IP)
  # ========================================
  jaeger:
    image: jaegertracing/all-in-one:1.58
    ports:
      - "16686:16686"
    networks: [internal]

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks: [internal]

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    networks: [internal]
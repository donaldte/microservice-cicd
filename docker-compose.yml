version: "3.9"

networks:
  traefik-public:
    external: true
  internal:
    driver: overlay
    attachable: true  # permet aux services non-swarm de s’y connecter si besoin

services:
  # ========================================
  # TRAEFIK
  # ========================================
  traefik:
    image: traefik:v3.1
    command:
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedByDefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
      - "--api.insecure=false"          # sécurisé en prod
      - "--log.level=INFO"
    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
      - target: 8080
        published: 8080
        mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/data/traefik/acme.json:/acme.json
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`traefik.yourdomain.com`)"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.routers.dashboard.entrypoints=websecure"
        - "traefik.http.routers.dashboard.tls.certresolver=myresolver"
    networks:
      - traefik-public

  # ========================================
  # GATEWAY + MICRO-SERVICES (tous identiques)
  # ========================================
  gateway-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-gateway:${IMAGE_TAG:-latest}
    deploy:
      replicas: 3
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.gateway.rule=Host(`api.yourdomain.com`)"
        - "traefik.http.routers.gateway.entrypoints=websecure"
        - "traefik.http.routers.gateway.tls.certresolver=myresolver"
        - "traefik.http.services.gateway.loadbalancer.server.port=8000"
    networks:
      - traefik-public
      - internal

  auth-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-auth:${IMAGE_TAG:-latest}
    deploy:
      replicas: 2
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.auth.rule=Host(`auth.yourdomain.com`)"
        - "traefik.http.routers.auth.entrypoints=websecure"
        - "traefik.http.routers.auth.tls.certresolver=myresolver"
        - "traefik.http.services.auth.loadbalancer.server.port=8000"
    networks:
      - internal
      - traefik-public

  # (project-service, billing-service, notification-service, analytics-service → même pattern)
  # Je te les mets en version raccourcie pour éviter la répétition :

  project-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-project:${IMAGE_TAG:-latest}
    deploy: { replicas: 2 }
    networks: [internal, traefik-public]
    configs:
      - source: app-config
        target: /app/config.yaml

  billing-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-billing:${IMAGE_TAG:-latest}
    deploy: { replicas: 2 }
    networks: [internal, traefik-public]

  notification-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-notification:${IMAGE_TAG:-latest}
    deploy: { replicas: 2 }
    networks: [internal, traefik-public]

  analytics-service:
    image: ${DOCKERHUB_USERNAME}/cloudtaskhub-analytics:${IMAGE_TAG:-latest}
    deploy: { replicas: 2 }
    networks: [internal, traefik-public]

  # ========================================
  # KAFKA KRaft (3 nœuds – sans Zookeeper !)
  # ========================================
  kafka-1:
    image: bitnami/kafka
    hostname: kafka-1
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-1:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    deploy:
      replicas: 1
      placement:
        constraints: [node.labels.kafka == node1]  # optionnel
    networks:
      - internal

  kafka-2:
    image: bitnami/kafka:3.8.0
    hostname: kafka-2
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=2
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-2:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    deploy: { replicas: 1 }
    networks: [internal]

  kafka-3:
    image: bitnami/kafka:3.8.0
    hostname: kafka-3
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_NODE_ID=3
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-3:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    deploy: { replicas: 1 }
    networks: [internal]

  # Dans tes services, utilise simplement :
  # KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092

  # ========================================
  # OBSERVABILITY
  # ========================================
  jaeger:
    image: jaegertracing/all-in-one:1.58
    ports:
      - "16686:16686"
    networks: [internal]

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks: [internal]

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    networks: [internal]

configs:
  app-config:
    file: ./configs/app.yaml